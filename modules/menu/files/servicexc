#!/bin/bash
# servicexc - Service execution wrapper for CtxOS
# Manages system services with proper privilege escalation and user feedback

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored messages
print_info() {
    echo -e "${BLUE}[*]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[✓]${NC} $1"
}

print_error() {
    echo -e "${RED}[✗]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

# Function to show GUI notification
notify() {
    local title="$1"
    local message="$2"
    local type="${3:-info}" # info, success, error, warning
    
    if command -v notify-send &> /dev/null; then
        case "$type" in
            success)
                notify-send -i dialog-information "$title" "$message"
                ;;
            error)
                notify-send -i dialog-error "$title" "$message"
                ;;
            warning)
                notify-send -i dialog-warning "$title" "$message"
                ;;
            *)
                notify-send -i dialog-information "$title" "$message"
                ;;
        esac
    fi
}

# Function to check if running as root
check_root() {
    if [ "$EUID" -ne 0 ]; then
        return 1
    fi
    return 0
}

# Function to get service status
get_service_status() {
    local service="$1"
    
    if systemctl is-active --quiet "$service" 2>/dev/null; then
        echo "running"
    elif systemctl is-enabled --quiet "$service" 2>/dev/null; then
        echo "stopped"
    else
        echo "disabled"
    fi
}

# Function to execute service command
execute_service_command() {
    local service="$1"
    local action="$2"
    
    print_info "Service: $service"
    print_info "Action: $action"
    echo ""
    
    # Check if service exists
    if ! systemctl list-unit-files | grep -q "^${service}.service"; then
        print_error "Service '$service' not found"
        notify "Service Error" "Service '$service' is not installed" "error"
        return 1
    fi
    
    # Get current status
    local status=$(get_service_status "$service")
    print_info "Current status: $status"
    echo ""
    
    # Execute action with sudo if needed
    local cmd="systemctl $action $service"
    
    if ! check_root; then
        print_warning "Root privileges required. Requesting sudo..."
        cmd="sudo $cmd"
    fi
    
    print_info "Executing: $cmd"
    echo "========================================"
    
    if eval "$cmd"; then
        echo "========================================"
        print_success "Command completed successfully"
        
        # Get new status
        local new_status=$(get_service_status "$service")
        print_info "New status: $new_status"
        
        notify "Service $action" "Service '$service' $action completed successfully" "success"
        return 0
    else
        echo "========================================"
        print_error "Command failed"
        notify "Service Error" "Failed to $action service '$service'" "error"
        return 1
    fi
}

# Main script
main() {
    echo "========================================"
    echo "  CtxOS Service Manager"
    echo "========================================"
    echo ""
    
    # Check arguments
    if [ $# -lt 2 ]; then
        print_error "Invalid arguments"
        echo ""
        echo "Usage: servicexc <service> <action>"
        echo ""
        echo "Actions:"
        echo "  start     - Start the service"
        echo "  stop      - Stop the service"
        echo "  restart   - Restart the service"
        echo "  status    - Show service status"
        echo "  enable    - Enable service at boot"
        echo "  disable   - Disable service at boot"
        echo ""
        notify "Service Manager" "Invalid arguments provided" "error"
        return 1
    fi
    
    local service="$1"
    local action="$2"
    
    # Validate action
    case "$action" in
        start|stop|restart|status|enable|disable|reload)
            execute_service_command "$service" "$action"
            ;;
        *)
            print_error "Invalid action: $action"
            echo ""
            echo "Valid actions: start, stop, restart, status, enable, disable, reload"
            notify "Service Manager" "Invalid action: $action" "error"
            return 1
            ;;
    esac
    
    local exit_code=$?
    
    echo ""
    echo "========================================"
    echo "Press Enter to close..."
    read
    
    return $exit_code
}

# Run main function
main "$@"
