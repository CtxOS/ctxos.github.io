#!/bin/bash
# ctxos-ls - List and discover CtxOS security tools
# Shows installed tools, categories, and provides search functionality

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Directories to search
DESKTOP_DIRS=(
    "/usr/share/applications"
    "$HOME/.local/share/applications"
)

DESKTOP_CATEGORY_DIR="/usr/share/desktop-directories"

# Function to print colored messages
print_header() {
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${CYAN}$1${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

print_category() {
    echo -e "${MAGENTA}▶ $1${NC}"
}

print_tool() {
    local name="$1"
    local desc="$2"
    echo -e "  ${GREEN}•${NC} ${BLUE}$name${NC}"
    if [ -n "$desc" ]; then
        echo -e "    ${desc}"
    fi
}

print_info() {
    echo -e "${YELLOW}[i]${NC} $1"
}

# Function to extract desktop file info
get_desktop_info() {
    local file="$1"
    local field="$2"
    
    grep "^${field}=" "$file" 2>/dev/null | head -1 | cut -d'=' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'
}

# Function to list all CtxOS tools
list_all_tools() {
    print_header "CtxOS Security Tools"
    
    local count=0
    local tools=()
    
    # Collect all ctxos-* desktop files
    for dir in "${DESKTOP_DIRS[@]}"; do
        if [ -d "$dir" ]; then
            while IFS= read -r -d '' file; do
                local name=$(get_desktop_info "$file" "Name")
                local comment=$(get_desktop_info "$file" "Comment")
                local exec=$(get_desktop_info "$file" "Exec")
                
                if [ -n "$name" ]; then
                    tools+=("$name|$comment|$exec")
                    ((count++))
                fi
            done < <(find "$dir" -name "ctxos-*.desktop" -print0 2>/dev/null)
        fi
    done
    
    # Sort and display
    if [ ${#tools[@]} -gt 0 ]; then
        printf '%s\n' "${tools[@]}" | sort | while IFS='|' read -r name comment exec; do
            print_tool "$name" "$comment"
        done
        echo ""
        print_info "Total tools: $count"
    else
        print_info "No CtxOS tools found"
    fi
}

# Function to list tools by category
list_by_category() {
    local category="$1"
    
    print_header "Tools in Category: $category"
    
    local count=0
    
    for dir in "${DESKTOP_DIRS[@]}"; do
        if [ -d "$dir" ]; then
            while IFS= read -r -d '' file; do
                local categories=$(get_desktop_info "$file" "Categories")
                
                if [[ "$categories" =~ $category ]]; then
                    local name=$(get_desktop_info "$file" "Name")
                    local comment=$(get_desktop_info "$file" "Comment")
                    
                    print_tool "$name" "$comment"
                    ((count++))
                fi
            done < <(find "$dir" -name "*.desktop" -print0 2>/dev/null)
        fi
    done
    
    echo ""
    print_info "Tools found: $count"
}

# Function to list all categories
list_categories() {
    print_header "CtxOS Tool Categories"
    
    if [ ! -d "$DESKTOP_CATEGORY_DIR" ]; then
        print_info "No categories found"
        return
    fi
    
    # Main categories
    echo -e "${MAGENTA}Main Categories:${NC}"
    while IFS= read -r -d '' file; do
        local basename=$(basename "$file" .directory)
        local name=$(get_desktop_info "$file" "Name")
        
        if [[ "$basename" =~ ^[0-9]{2}- ]] && [[ ! "$basename" =~ ^[0-9]{2}-[0-9]{2}- ]]; then
            echo -e "  ${GREEN}•${NC} ${BLUE}$basename${NC} - $name"
        fi
    done < <(find "$DESKTOP_CATEGORY_DIR" -name "*.directory" -print0 2>/dev/null | sort -z)
    
    echo ""
    
    # Special categories
    echo -e "${MAGENTA}Special Categories:${NC}"
    for special in "Ctxos" "services" "top10" "privacy" "cryptography" "sandbox"; do
        if [ -f "$DESKTOP_CATEGORY_DIR/${special}.directory" ]; then
            local name=$(get_desktop_info "$DESKTOP_CATEGORY_DIR/${special}.directory" "Name")
            echo -e "  ${GREEN}•${NC} ${BLUE}$special${NC} - $name"
        fi
    done
}

# Function to search tools
search_tools() {
    local query="$1"
    
    print_header "Search Results: $query"
    
    local count=0
    
    for dir in "${DESKTOP_DIRS[@]}"; do
        if [ -d "$dir" ]; then
            while IFS= read -r -d '' file; do
                local name=$(get_desktop_info "$file" "Name")
                local comment=$(get_desktop_info "$file" "Comment")
                local exec=$(get_desktop_info "$file" "Exec")
                
                # Case-insensitive search in name, comment, or exec
                if [[ "${name,,}" =~ ${query,,} ]] || \
                   [[ "${comment,,}" =~ ${query,,} ]] || \
                   [[ "${exec,,}" =~ ${query,,} ]]; then
                    print_tool "$name" "$comment"
                    ((count++))
                fi
            done < <(find "$dir" -name "*.desktop" -print0 2>/dev/null)
        fi
    done
    
    echo ""
    print_info "Results found: $count"
}

# Function to show tool details
show_tool_details() {
    local tool_name="$1"
    
    for dir in "${DESKTOP_DIRS[@]}"; do
        if [ -d "$dir" ]; then
            local file="$dir/${tool_name}.desktop"
            
            if [ -f "$file" ]; then
                print_header "Tool Details: $tool_name"
                
                echo -e "${YELLOW}Name:${NC}       $(get_desktop_info "$file" "Name")"
                echo -e "${YELLOW}Comment:${NC}    $(get_desktop_info "$file" "Comment")"
                echo -e "${YELLOW}Exec:${NC}       $(get_desktop_info "$file" "Exec")"
                echo -e "${YELLOW}Icon:${NC}       $(get_desktop_info "$file" "Icon")"
                echo -e "${YELLOW}Terminal:${NC}   $(get_desktop_info "$file" "Terminal")"
                echo -e "${YELLOW}Categories:${NC} $(get_desktop_info "$file" "Categories")"
                echo -e "${YELLOW}Package:${NC}    $(get_desktop_info "$file" "X-Ctxos-Package")"
                echo -e "${YELLOW}File:${NC}       $file"
                
                return 0
            fi
        fi
    done
    
    print_info "Tool not found: $tool_name"
    return 1
}

# Function to show statistics
show_stats() {
    print_header "CtxOS Tools Statistics"
    
    local total=0
    local ctxos_tools=0
    local native_tools=0
    local services=0
    
    for dir in "${DESKTOP_DIRS[@]}"; do
        if [ -d "$dir" ]; then
            total=$((total + $(find "$dir" -name "*.desktop" 2>/dev/null | wc -l)))
            ctxos_tools=$((ctxos_tools + $(find "$dir" -name "ctxos-*.desktop" 2>/dev/null | wc -l)))
            native_tools=$((native_tools + $(find "$dir" -name "native-*.desktop" 2>/dev/null | wc -l)))
            services=$((services + $(find "$dir" -name "serv-*.desktop" 2>/dev/null | wc -l)))
        fi
    done
    
    echo -e "${YELLOW}Total Applications:${NC}     $total"
    echo -e "${YELLOW}CtxOS Tools:${NC}            $ctxos_tools"
    echo -e "${YELLOW}Native Tools:${NC}           $native_tools"
    echo -e "${YELLOW}Services:${NC}               $services"
    
    if [ -d "$DESKTOP_CATEGORY_DIR" ]; then
        local categories=$(find "$DESKTOP_CATEGORY_DIR" -name "*.directory" 2>/dev/null | wc -l)
        echo -e "${YELLOW}Categories:${NC}             $categories"
    fi
}

# Function to show help
show_help() {
    cat << EOF
CtxOS Tools Listing and Discovery

Usage: ctxos-ls [COMMAND] [OPTIONS]

Commands:
  list, ls              List all CtxOS tools (default)
  categories, cat       List all available categories
  category <name>       List tools in specific category
  search <query>        Search for tools by name or description
  info <tool>           Show detailed information about a tool
  stats                 Show statistics about installed tools
  help                  Show this help message

Examples:
  ctxos-ls                          # List all tools
  ctxos-ls categories               # Show all categories
  ctxos-ls category 01-info-gathering
  ctxos-ls search nmap              # Search for nmap
  ctxos-ls info ctxos-nmap          # Show nmap details
  ctxos-ls stats                    # Show statistics

Environment:
  CTXOS_LS_COLOR=0     Disable colored output

EOF
}

# Main function
main() {
    local command="${1:-list}"
    
    # Check for color support
    if [ "${CTXOS_LS_COLOR:-1}" = "0" ] || [ ! -t 1 ]; then
        RED='' GREEN='' BLUE='' YELLOW='' CYAN='' MAGENTA='' NC=''
    fi
    
    case "$command" in
        list|ls)
            list_all_tools
            ;;
        categories|cat)
            list_categories
            ;;
        category)
            if [ -z "$2" ]; then
                echo "Error: Category name required"
                echo "Usage: ctxos-ls category <name>"
                exit 1
            fi
            list_by_category "$2"
            ;;
        search)
            if [ -z "$2" ]; then
                echo "Error: Search query required"
                echo "Usage: ctxos-ls search <query>"
                exit 1
            fi
            search_tools "$2"
            ;;
        info)
            if [ -z "$2" ]; then
                echo "Error: Tool name required"
                echo "Usage: ctxos-ls info <tool>"
                exit 1
            fi
            show_tool_details "$2"
            ;;
        stats)
            show_stats
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "Error: Unknown command: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
