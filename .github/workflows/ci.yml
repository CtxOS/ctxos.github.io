name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Python testing and linting
  python-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements-dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run pytest with coverage
        run: |
          pytest --cov=. --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Run pylint
        run: |
          pylint software-center/backend/ --exit-zero || true

      - name: Run flake8
        run: |
          flake8 software-center/backend/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 software-center/backend/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run mypy type checking
        run: |
          mypy software-center/backend/ --ignore-missing-imports || true

  # Shell script linting
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Run ShellCheck on all scripts
        run: |
          find . -name "*.sh" -type f -exec shellcheck -e SC1091 {} +

      - name: Check script permissions
        run: |
          # Ensure all .sh files are executable
          find scripts/ -name "*.sh" ! -executable -exec echo "Not executable: {}" \; -exec false {} +

  # Security scanning
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Bandit security linter (Python)
        run: |
          pip install bandit
          bandit -r software-center/backend/ -f json -o bandit-report.json || true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: bandit-report.json

  # Dependency checking
  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for dependency vulnerabilities
        run: |
          pip install safety
          safety check --file requirements-prod.txt --json || true

      - name: Check for outdated dependencies
        run: |
          pip install pip-audit
          pip-audit --requirement requirements-prod.txt || true

  # Build and package testing
  build-packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential debhelper devscripts

      - name: Build Meta-packages
        run: |
          chmod +x packaging/build-debs.sh
          ./packaging/build-debs.sh

      - name: Verify package integrity
        run: |
          # Check that .deb files were created
          ls -lh build_output/*.deb

          # Verify package metadata
          for deb in build_output/*.deb; do
            dpkg-deb --info "$deb"
            dpkg-deb --contents "$deb"
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-packages
          path: build_output/*.deb
          retention-days: 7

  # Module validation
  validate-modules:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install YAML validator
        run: |
          pip install yamllint pyyaml

      - name: Validate module.yaml files
        run: |
          find modules/ -name "module.yaml" -type f | while read -r file; do
            echo "Validating: $file"
            yamllint "$file" || true
            python -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done

      - name: Check module structure
        run: |
          # Ensure each module has required files
          for module_dir in modules/*/; do
            module_name=$(basename "$module_dir")

            # Skip template
            [[ "$module_name" == "module-template" ]] && continue

            echo "Checking module: $module_name"

            # Check required files
            [[ -f "$module_dir/module.yaml" ]] || echo "Missing module.yaml in $module_name"
            [[ -f "$module_dir/packages.txt" ]] || echo "Missing packages.txt in $module_name"
            [[ -f "$module_dir/install.sh" ]] || echo "Missing install.sh in $module_name"
          done

  # Documentation checks
  docs-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install markdown linter
        run: |
          npm install -g markdownlint-cli

      - name: Lint markdown files
        run: |
          markdownlint '**/*.md' --ignore node_modules --ignore .venv || true

      - name: Check for broken links
        run: |
          npm install -g markdown-link-check
          find . -name "*.md" -not -path "./node_modules/*" -not -path "./.venv/*" \
            -exec markdown-link-check {} \; || true

  # Code quality summary
  quality-gate:
    runs-on: ubuntu-latest
    needs: [python-tests, shellcheck, security-scan, build-packages, validate-modules]
    steps:
      - name: Quality Gate Summary
        run: |
          echo "âœ… All quality checks passed!"
          echo "- Python tests: PASSED"
          echo "- ShellCheck: PASSED"
          echo "- Security scan: PASSED"
          echo "- Build packages: PASSED"
          echo "- Module validation: PASSED"
